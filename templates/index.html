<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Rete Distributori Iperstaroil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #mappa { height: 500px; width: 100%; margin-top: 20px; }
        #provincia { margin-bottom: 10px; }
        button { padding: 5px 10px; margin-left: 5px; }
        .prezzi { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Distributori Iperstaroil</h1>

    <label for="provincia">Filtra per provincia:</label>
    <input type="text" id="provincia" placeholder="es. MI">
    <button onclick="caricaProvincia()">Filtra</button>
    <button onclick="caricaTutti()">Mostra tutti</button>

    <table id="tabella_distributori">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Provincia</th>
                <th>Indirizzo</th>
                <th>Benzina</th>
                <th>Diesel</th>
                <th>% Benzina</th>
                <th>% Diesel</th>
                <th>Prezzo Benzina</th>
                <th>Prezzo Diesel</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="prezzi">
        <h3>Modifica prezzi per provincia</h3>
        <label for="provinciaPrezzi">Provincia:</label>
        <input type="text" id="provinciaPrezzi" placeholder="es. MI">
        <label for="benzinaPrezzo">Benzina (€):</label>
        <input type="number" step="0.01" id="benzinaPrezzo">
        <label for="dieselPrezzo">Diesel (€):</label>
        <input type="number" step="0.01" id="dieselPrezzo">
        <button onclick="modificaPrezzi()">Aggiorna Prezzi</button>
    </div>

    <div id="mappa"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mappa;
        let markers = [];

        function inizializzaMappa() {
            mappa = L.map('mappa').setView([45.5, 9.2], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mappa);
        }

        function aggiornaMappa(distributori) {
            markers.forEach(m => mappa.removeLayer(m));
            markers = [];
            distributori.forEach(d => {
                const marker = L.marker([d.lat, d.lon])
                    .addTo(mappa)
                    .bindPopup(`<b>${d.nome}</b><br>${d.indirizzo}<br>
                                Benzina: ${d.livello_benzina} L<br>
                                Diesel: ${d.livello_diesel} L<br>
                                Prezzo Benzina: €${d.prezzo_benzina.toFixed(2)}<br>
                                Prezzo Diesel: €${d.prezzo_diesel.toFixed(2)}`);
                markers.push(marker);
            });
            if (distributori.length > 0) {
                const latMedia = distributori.reduce((sum, d) => sum + d.lat, 0) / distributori.length;
                const lonMedia = distributori.reduce((sum, d) => sum + d.lon, 0) / distributori.length;
                mappa.setView([latMedia, lonMedia], 11);
            }
        }

        function popolaTabella(distributori) {
            const tbody = document.querySelector("#tabella_distributori tbody");
            tbody.innerHTML = "";
            distributori.forEach(d => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${d.id}</td><td>${d.nome}</td><td>${d.provincia}</td>
                    <td>${d.indirizzo}</td>
                    <td>${d.livello_benzina} / ${d.capacita_benzina}</td>
                    <td>${d.livello_diesel} / ${d.capacita_diesel}</td>
                    <td>${d.percent_benzina.toFixed(1)}%</td>
                    <td>${d.percent_diesel.toFixed(1)}%</td>
                    <td>€${d.prezzo_benzina.toFixed(2)}</td>
                    <td>€${d.prezzo_diesel.toFixed(2)}</td>`;
                tbody.appendChild(row);
            });
        }

        async function caricaTutti() {
            const response = await fetch("/api/distributori");
            const data = await response.json();
            popolaTabella(data);
            aggiornaMappa(data);
        }

        async function caricaProvincia() {
            const provincia = document.getElementById("provincia").value.trim();
            if (!provincia) return;
            const response = await fetch(`/api/distributori/provincia/${provincia}/livelli`);
            const data = await response.json();
            popolaTabella(data);
            aggiornaMappa(data);
        }

        async function modificaPrezzi() {
            const provincia = document.getElementById("provinciaPrezzi").value.trim();
            const benzina = document.getElementById("benzinaPrezzo").value;
            const diesel = document.getElementById("dieselPrezzo").value;

            if (!provincia) { alert("Inserisci la provincia!"); return; }

            const body = {};
            if (benzina) body.benzina = parseFloat(benzina);
            if (diesel) body.diesel = parseFloat(diesel);

            if (!Object.keys(body).length) { alert("Inserisci almeno un prezzo!"); return; }

            const response = await fetch(`/api/distributori/provincia/${provincia}/prezzi`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (response.ok) {
                alert("Prezzi aggiornati distributori: " + data.aggiornati.join(", "));
                caricaProvincia();
            } else {
                alert("Errore: " + data.error);
            }
        }

        inizializzaMappa();
        caricaTutti();
    </script>
</body>
</html>